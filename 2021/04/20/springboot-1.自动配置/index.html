<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>springboot-自动配置 - 景瑞的博客</title><link rel="manifest" href="/blog/manifest.json"><meta name="application-name" content="景瑞的博客"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="景瑞的博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="一直都在用springboot的自动化配置，但是一直没有总结。"><meta property="og:type" content="blog"><meta property="og:title" content="springboot-自动配置"><meta property="og:url" content="http://jingruihe.gitee.io/blog/2021/04/20/springboot-1.%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE/"><meta property="og:site_name" content="景瑞的博客"><meta property="og:description" content="一直都在用springboot的自动化配置，但是一直没有总结。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://jingruihe.gitee.io/blog/img/og_image.png"><meta property="article:published_time" content="2021-04-20T03:35:25.000Z"><meta property="article:modified_time" content="2021-05-12T15:49:01.418Z"><meta property="article:author" content="JingRui"><meta property="article:tag" content="springboot"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/blog/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://jingruihe.gitee.io/blog/2021/04/20/springboot-1.%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE/"},"headline":"springboot-自动配置","image":["http://jingruihe.gitee.io/blog/img/og_image.png"],"datePublished":"2021-04-20T03:35:25.000Z","dateModified":"2021-05-12T15:49:01.418Z","author":{"@type":"Person","name":"JingRui"},"description":"一直都在用springboot的自动化配置，但是一直没有总结。"}</script><link rel="canonical" href="http://jingruihe.gitee.io/blog/2021/04/20/springboot-1.%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE/"><link rel="icon" href="/blog/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/blog/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/blog/"><img src="/blog/img/logo.svg" alt="景瑞的博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/blog/">主页</a><a class="navbar-item" href="/blog/archives">归档</a><a class="navbar-item" href="/blog/categories">分类</a><a class="navbar-item" href="/blog/tags">标签</a><a class="navbar-item" href="/blog/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on Gitee" href="https://gitee.com/jingruihe"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-20T03:35:25.000Z" title="2021/4/20上午11:35:25">2021-04-20</time>发表</span><span class="level-item"><time dateTime="2021-05-12T15:49:01.418Z" title="2021/5/12下午11:49:01">2021-05-12</time>更新</span><span class="level-item"><a class="link-muted" href="/blog/categories/%E5%90%8E%E5%8F%B0/">后台</a></span><span class="level-item">20 分钟读完 (大约2968个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">springboot-自动配置</h1><div class="content"><p>一直都在用springboot的自动化配置，但是一直没有总结。</p>
<span id="more"></span>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class DemoSpringbootApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(DemoSpringbootApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="SpringBootApplication"><a href="#SpringBootApplication" class="headerlink" title="@SpringBootApplication"></a>@SpringBootApplication</h1><ol>
<li><code>@SpringBootApplication</code>包含了<code>@EnableAutoConfiguration</code>注解</li>
<li><code>@EnableAutoConfiguration</code>注解主要点在<code>@Import(AutoConfigurationImportSelector.class)</code>和<code>@AutoConfigurationPackage</code></li>
</ol>
<p><code>@AutoConfigurationPackage</code>源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@Import(AutoConfigurationPackages.Registrar.class)</span><br><span class="line">public @interface AutoConfigurationPackage &#123;</span><br><span class="line">	String[] basePackages() default &#123;&#125;;</span><br><span class="line">	Class&lt;?&gt;[] basePackageClasses() default &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Registrar源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">static class Registrar implements ImportBeanDefinitionRegistrar, DeterminableImports &#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void registerBeanDefinitions(AnnotationMetadata metadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line">		&#x2F;&#x2F;这里其实扫描了项目的顶级包名，这就是为什么Springboot可以扫描Application包名以下所有包名</span><br><span class="line">		register(registry, new PackageImports(metadata).getPackageNames().toArray(new String[0]));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public Set&lt;Object&gt; determineImports(AnnotationMetadata metadata) &#123;</span><br><span class="line">		return Collections.singleton(new PackageImports(metadata));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AutoConfigurationImportSelector源码，主要方法是在<code>getAutoConfigurationEntry</code>下面的<code>List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;String&gt; getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) &#123;</span><br><span class="line">	List&lt;String&gt; configurations &#x3D; SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(),</span><br><span class="line">			getBeanClassLoader());</span><br><span class="line">	Assert.notEmpty(configurations, &quot;No auto configuration classes found in META-INF&#x2F;spring.factories. If you &quot;</span><br><span class="line">			+ &quot;are using a custom packaging, make sure that file is correct.&quot;);</span><br><span class="line">	return configurations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会去找<code>META-INF/spring.factories</code>的key为<code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code>对应的value。<br>这个值就是自动化加载的类名，这里只是放入一个ConcurrentReferenceHashMap缓存中。</p>
<h1 id="SpringApplication-run"><a href="#SpringApplication-run" class="headerlink" title="SpringApplication.run()"></a>SpringApplication.run()</h1><ul>
<li><code>new SpringApplication()</code>并且初始化了一些参数的配置和监听器的处理</li>
<li><code>run()</code>这里面主要就是启动了初始化的监听器，设置一些初始参数</li>
</ul>
<p><code>run()</code>调用<code>createApplicationContext()</code></p>
<p>这里如果用SERVLET会实例化一个AnnotationConfigServletWebServerApplicationContext，这个构造方法是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public AnnotationConfigServletWebServerApplicationContext() &#123;</span><br><span class="line">		this.reader &#x3D; new AnnotatedBeanDefinitionReader(this);</span><br><span class="line">		this.scanner &#x3D; new ClassPathBeanDefinitionScanner(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而AnnotatedBeanDefinitionReader构造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public AnnotatedBeanDefinitionReader(BeanDefinitionRegistry registry, Environment environment) &#123;</span><br><span class="line">		Assert.notNull(registry, &quot;BeanDefinitionRegistry must not be null&quot;);</span><br><span class="line">		Assert.notNull(environment, &quot;Environment must not be null&quot;);</span><br><span class="line">		this.registry &#x3D; registry;</span><br><span class="line">		&#x2F;&#x2F;用于处理 @ConditionalOnBean @ConditionalOnClass </span><br><span class="line">		this.conditionEvaluator &#x3D; new ConditionEvaluator(registry, environment, null);</span><br><span class="line">		&#x2F;&#x2F;为IOC容器注册相关的后置处理器   </span><br><span class="line">		AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">***</span><br><span class="line">Set&lt;BeanDefinitionHolder&gt; beanDefs &#x3D; new LinkedHashSet&lt;&gt;(8);</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line">检查IOC容器是否有ConfigurationClassPostProcessor，没有加入BeanDefinitionRegistry</span><br><span class="line">**&#x2F;</span><br><span class="line">if (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">	&#x2F;&#x2F;如果不存在， 创建RootBeanDefinition</span><br><span class="line">	RootBeanDefinition def &#x3D; new RootBeanDefinition(ConfigurationClassPostProcessor.class);</span><br><span class="line">	def.setSource(source);</span><br><span class="line">	&#x2F;&#x2F;往IOC容器注册 ConfigurationClassPostProcessor</span><br><span class="line">	beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">***</span><br><span class="line"></span><br><span class="line">private static BeanDefinitionHolder registerPostProcessor(</span><br><span class="line">		BeanDefinitionRegistry registry, RootBeanDefinition definition, String beanName) &#123;</span><br><span class="line">	definition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">	&#x2F;&#x2F;往IOC容器注册 BeanDefinition </span><br><span class="line">	registry.registerBeanDefinition(beanName, definition);</span><br><span class="line">	return new BeanDefinitionHolder(definition, beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConfigurationClassPostProcessor继承了BeanDefinitionRegistryPostProcessor，IOC容器在启动后会优先先加载容器中的后置处理器，并执行后置处理器的方法。</p>
<p>在run()中会调用<code>refreshContext()</code>方法，最终还是调到spring的refresh方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 容器初始化前的准备工作</span><br><span class="line">prepareRefresh();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 初始化 DefaultListableBeanFactory</span><br><span class="line">ConfigurableListableBeanFactory beanFactory &#x3D; obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 为beanFactory设置容器特性，例如类加载器、事件处理器等</span><br><span class="line">prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">try &#123;</span><br><span class="line">	&#x2F;&#x2F;空实现，为容器的某些子类指定特殊的beanPost事件处理器</span><br><span class="line">	postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;调用所有注册的BeanFactoryPostProcessor的bean</span><br><span class="line">	invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;将BeanPostProcessor后置处理器的bean追加到BeanFactory的Bean后置处理器列表中，用于触发bean的生命周期</span><br><span class="line">	registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;初始化信息源，和国际化相关</span><br><span class="line">	initMessageSource();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;初始化容器事件传播器</span><br><span class="line">	initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;调用子类的某些特殊bean初始化方法</span><br><span class="line">	onRefresh();</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;为事件传播器注册事件监听器</span><br><span class="line">	registerListeners();</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;初始化所有剩余的单例bean</span><br><span class="line">	finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;初始化容器的生命周期时间处理器，并发布容器的生命周期事件</span><br><span class="line">	finishRefresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>invokeBeanFactoryPostProcessors()</code>方法会把BeanFactory里注册的<code>BeanBeanFactoryPostProcessor</code>类型的bean优先实例化并进行调用</p>
<p>ConfigurationClassPostProcessor作用是修改IOC容器中的元数据，SpringBoot就是在此加载自动装配类注册到IOC容器中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">	&#x2F;&#x2F;为入参的IOC容器生成唯一的id</span><br><span class="line">	int registryId &#x3D; System.identityHashCode(registry);</span><br><span class="line">	&#x2F;&#x2F;如果处理过了，则抛异常</span><br><span class="line">	if (this.registriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">		throw new IllegalStateException(</span><br><span class="line">				&quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot; + registry);</span><br><span class="line">	&#125;</span><br><span class="line">	&#x2F;&#x2F;如果处理过了，则抛异常</span><br><span class="line">	if (this.factoriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">		throw new IllegalStateException(</span><br><span class="line">				&quot;postProcessBeanFactory already called on this post-processor against &quot; + registry);</span><br><span class="line">	&#125;</span><br><span class="line">	&#x2F;&#x2F;追加处理过的标识</span><br><span class="line">	this.registriesPostProcessed.add(registryId);</span><br><span class="line">	&#x2F;&#x2F;开始进行自动装配类的加载</span><br><span class="line">	processConfigBeanDefinitions(registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>processConfigBeanDefinitions</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">	&#x2F;&#x2F;缓存拥有@Configuration注解的bean</span><br><span class="line">	List&lt;BeanDefinitionHolder&gt; configCandidates &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">	&#x2F;&#x2F;获取容器中所有已注册的bean名称</span><br><span class="line">	String[] candidateNames &#x3D; registry.getBeanDefinitionNames();</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F;遍历所有bean</span><br><span class="line">	for (String beanName : candidateNames) &#123;</span><br><span class="line">		&#x2F;&#x2F;得到 BeanDefinition</span><br><span class="line">		BeanDefinition beanDef &#x3D; registry.getBeanDefinition(beanName);</span><br><span class="line">		&#x2F;&#x2F;检查 BeanDefinition 是否有包含configurationClass属性的值，有值证明已处理过，则忽略加入缓存</span><br><span class="line">		if (ConfigurationClassUtils.isFullConfigurationClass(beanDef) ||</span><br><span class="line">				ConfigurationClassUtils.isLiteConfigurationClass(beanDef)) &#123;</span><br><span class="line">			if (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(&quot;Bean definition has already been processed as a configuration class: &quot; + beanDef);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		&#x2F;&#x2F;检查 BeanDefinition 的目标类是否包含@Configuration 注解</span><br><span class="line">		else if (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)) &#123;</span><br><span class="line">			&#x2F;&#x2F;追加到缓存中</span><br><span class="line">			configCandidates.add(new BeanDefinitionHolder(beanDef, beanName));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 缓存为空 则忽略</span><br><span class="line">	if (configCandidates.isEmpty()) &#123;</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 进行排序</span><br><span class="line">	configCandidates.sort((bd1, bd2) -&gt; &#123;</span><br><span class="line">		int i1 &#x3D; ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());</span><br><span class="line">		int i2 &#x3D; ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());</span><br><span class="line">		return Integer.compare(i1, i2);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 从容器中获取自定义的bean名称生成策略</span><br><span class="line">	SingletonBeanRegistry sbr &#x3D; null;</span><br><span class="line">	if (registry instanceof SingletonBeanRegistry) &#123;</span><br><span class="line">		sbr &#x3D; (SingletonBeanRegistry) registry;</span><br><span class="line">		if (!this.localBeanNameGeneratorSet) &#123;</span><br><span class="line">			BeanNameGenerator generator &#x3D; (BeanNameGenerator) sbr.getSingleton(CONFIGURATION_BEAN_NAME_GENERATOR);</span><br><span class="line">			if (generator !&#x3D; null) &#123;</span><br><span class="line">				this.componentScanBeanNameGenerator &#x3D; generator;</span><br><span class="line">				this.importBeanNameGenerator &#x3D; generator;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	&#x2F;**</span><br><span class="line">		如果环境变量为空，则进行初始化，但SpringBoot在初始化 ApplicationContext 之前会初始化Environment ,</span><br><span class="line">		并注入到ApplicationContext中,所以下面的条件不会成立</span><br><span class="line">	**&#x2F;</span><br><span class="line">	if (this.environment &#x3D;&#x3D; null) &#123;</span><br><span class="line">		this.environment &#x3D; new StandardEnvironment();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 初始化 @Configuration 注解处理器</span><br><span class="line">	ConfigurationClassParser parser &#x3D; new ConfigurationClassParser(</span><br><span class="line">			this.metadataReaderFactory, this.problemReporter, this.environment,</span><br><span class="line">			this.resourceLoader, this.componentScanBeanNameGenerator, registry);</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F;缓存要处理的自动装配类</span><br><span class="line">	Set&lt;BeanDefinitionHolder&gt; candidates &#x3D; new LinkedHashSet&lt;&gt;(configCandidates);</span><br><span class="line">	&#x2F;&#x2F;缓存处理过的自动装配类</span><br><span class="line">	Set&lt;ConfigurationClass&gt; alreadyParsed &#x3D; new HashSet&lt;&gt;(configCandidates.size());</span><br><span class="line">	do &#123;</span><br><span class="line">		&#x2F;&#x2F;重点关注该方法，自动装配类的加载在里面完成</span><br><span class="line">		parser.parse(candidates);</span><br><span class="line">		&#x2F;&#x2F;校验工作</span><br><span class="line">		parser.validate();</span><br><span class="line">		&#x2F;&#x2F;把加载的装配类放到Set中</span><br><span class="line">		Set&lt;ConfigurationClass&gt; configClasses &#x3D; new LinkedHashSet&lt;&gt;(parser.getConfigurationClasses());</span><br><span class="line">		&#x2F;&#x2F;删除已处理过的自动装配类</span><br><span class="line">		configClasses.removeAll(alreadyParsed);</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; 初始化 自动装配类的bean读取器 ConfigurationClassBeanDefinitionReader</span><br><span class="line">		if (this.reader &#x3D;&#x3D; null) &#123;</span><br><span class="line">			this.reader &#x3D; new ConfigurationClassBeanDefinitionReader(</span><br><span class="line">					registry, this.sourceExtractor, this.resourceLoader, this.environment,</span><br><span class="line">					this.importBeanNameGenerator, parser.getImportRegistry());</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		&#x2F;**</span><br><span class="line">			主要逻辑是把装配类的所有被@Bean修饰的方法转换成 ConfigurationClassBeanDefinition 并注册到IOC</span><br><span class="line">		**&#x2F;</span><br><span class="line">		this.reader.loadBeanDefinitions(configClasses);</span><br><span class="line">		&#x2F;&#x2F;追加到处理过的自动装配类缓存中</span><br><span class="line">		alreadyParsed.addAll(configClasses);</span><br><span class="line">		&#x2F;&#x2F;清空要处理的自动装配类缓存</span><br><span class="line">		candidates.clear();</span><br><span class="line">		</span><br><span class="line">		&#x2F;&#x2F;如果此时IOC容器注册的bean数量大于加载装配类前缓存的bean数量，说明成功注册了新的 BeanDefinition 到IOC容器中</span><br><span class="line">		if (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;</span><br><span class="line">			&#x2F;&#x2F;IOC容器最新bean名称集合</span><br><span class="line">			String[] newCandidateNames &#x3D; registry.getBeanDefinitionNames();</span><br><span class="line">			&#x2F;&#x2F;老的bean名称集合</span><br><span class="line">			Set&lt;String&gt; oldCandidateNames &#x3D; new HashSet&lt;&gt;(Arrays.asList(candidateNames));</span><br><span class="line">			&#x2F;&#x2F;初始化处理过的装配类集合</span><br><span class="line">			Set&lt;String&gt; alreadyParsedClasses &#x3D; new HashSet&lt;&gt;();</span><br><span class="line">			for (ConfigurationClass configurationClass : alreadyParsed) &#123;</span><br><span class="line">				alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			&#x2F;&#x2F;遍历IOC容器最新bean名称集合</span><br><span class="line">			for (String candidateName : newCandidateNames) &#123;</span><br><span class="line">				&#x2F;&#x2F;如果老的bean名称集合不包含最新的bean名称</span><br><span class="line">				if (!oldCandidateNames.contains(candidateName)) &#123;</span><br><span class="line">					&#x2F;&#x2F;获取对应的BeanDefinition</span><br><span class="line">					BeanDefinition bd &#x3D; registry.getBeanDefinition(candidateName);</span><br><span class="line">					&#x2F;&#x2F;检查BeanDefinition 拥有@Configuration注解 ，并且在处理过的装配类缓存中不存在</span><br><span class="line">					if (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, this.metadataReaderFactory) &amp;&amp;</span><br><span class="line">							!alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;</span><br><span class="line">						&#x2F;&#x2F;追加到candidates缓存，下一次循环会继续处理	</span><br><span class="line">						candidates.add(new BeanDefinitionHolder(bd, candidateName));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			candidateNames &#x3D; newCandidateNames;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	while (!candidates.isEmpty());</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;往IOC容器注册自动装配类队列，队列里面包含了符合条件的自动装配类</span><br><span class="line">	&#x2F;&#x2F;名称为ConfigurationClassPostProcessor.importRegistry </span><br><span class="line">	if (sbr !&#x3D; null &amp;&amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;</span><br><span class="line">		sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (this.metadataReaderFactory instanceof CachingMetadataReaderFactory) &#123;</span><br><span class="line">		&#x2F;&#x2F; Clear cache in externally provided MetadataReaderFactory; this is a no-op</span><br><span class="line">		&#x2F;&#x2F; for a shared cache since it&#39;ll be cleared by the ApplicationContext.</span><br><span class="line">		((CachingMetadataReaderFactory) this.metadataReaderFactory).clearCache();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从IOC容器遍历所有注册的<code>BeanDefinition</code>，并对目标Class的注解进行递归查找拥有<code>@Configuration</code>注解的<code>BeanDefinition</code>，<br>第一次加载会加载到启动类对应的<code>BeanDefinition</code>，我们查看<code>@SpringBootApplication</code>源码<br>会看到<code>@SpringBootConfiguration</code>，点击查看<code>@SpringBootConfiguration</code>会看到<code>@Configuration</code>。<br>在run()方法的<code>prepareContext()</code>中注册的</p>
<p>ConfigurationClassParser.parse()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public void parse(Set&lt;BeanDefinitionHolder&gt; configCandidates) &#123;</span><br><span class="line">	&#x2F;&#x2F;初始化缓存集合</span><br><span class="line">	this.deferredImportSelectors &#x3D; new LinkedList&lt;&gt;();</span><br><span class="line">	&#x2F;&#x2F;遍历装配包装类</span><br><span class="line">	for (BeanDefinitionHolder holder : configCandidates) &#123;</span><br><span class="line">		&#x2F;&#x2F;得到真正装配类的 BeanDefinition</span><br><span class="line">		BeanDefinition bd &#x3D; holder.getBeanDefinition();</span><br><span class="line">		try &#123;</span><br><span class="line">			&#x2F;&#x2F;根据BeanDefinition 的不同实现类，委派给相应的解析方法</span><br><span class="line">			if (bd instanceof AnnotatedBeanDefinition) &#123;</span><br><span class="line">				parse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName());</span><br><span class="line">			&#125;</span><br><span class="line">			else if (bd instanceof AbstractBeanDefinition &amp;&amp; ((AbstractBeanDefinition) bd).hasBeanClass()) &#123;</span><br><span class="line">				parse(((AbstractBeanDefinition) bd).getBeanClass(), holder.getBeanName());</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				parse(bd.getBeanClassName(), holder.getBeanName());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">			throw ex;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (Throwable ex) &#123;</span><br><span class="line">			throw new BeanDefinitionStoreException(</span><br><span class="line">					&quot;Failed to parse configuration class [&quot; + bd.getBeanClassName() + &quot;]&quot;, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	&#x2F;&#x2F;最后处理DeferredImportSelector的实现类</span><br><span class="line">	processDeferredImportSelectors();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>三个不同的parse()解析方法，可以看到最终是委派给<code>processConfigurationClass(ConfigurationClass configClass)</code>进行处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">protected void processConfigurationClass(ConfigurationClass configClass) throws IOException &#123;</span><br><span class="line">	&#x2F;&#x2F;检查装配类是否需要跳过装配</span><br><span class="line">	if (this.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) &#123;</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line">	&#x2F;&#x2F;检查缓存是否加载过此装配类</span><br><span class="line">	ConfigurationClass existingClass &#x3D; this.configurationClasses.get(configClass);</span><br><span class="line">	if (existingClass !&#x3D; null) &#123;</span><br><span class="line">		&#x2F;&#x2F;如果装配类已加载</span><br><span class="line">		if (configClass.isImported()) &#123;</span><br><span class="line">			&#x2F;&#x2F;如果缓存装配类已加载</span><br><span class="line">			if (existingClass.isImported()) &#123;</span><br><span class="line">				&#x2F;&#x2F;合并加载类是由哪个装配类带出来的，可以理解为合并装配类的leader</span><br><span class="line">				existingClass.mergeImportedBy(configClass);</span><br><span class="line">			&#125;</span><br><span class="line">			&#x2F;&#x2F; Otherwise ignore new imported config class; existing non-imported class overrides it.</span><br><span class="line">			return;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			&#x2F;&#x2F;从缓存中删除装配类</span><br><span class="line">			this.configurationClasses.remove(configClass);</span><br><span class="line">			this.knownSuperclasses.values().removeIf(configClass::equals);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 将装配类转换为 SourceClass</span><br><span class="line">	SourceClass sourceClass &#x3D; asSourceClass(configClass);</span><br><span class="line">	</span><br><span class="line">	&#x2F;**</span><br><span class="line">			开始循环解析 ConfigurationClass 重点关注！</span><br><span class="line">	**&#x2F;</span><br><span class="line">	do &#123;</span><br><span class="line">		sourceClass &#x3D; doProcessConfigurationClass(configClass, sourceClass);</span><br><span class="line">	&#125;</span><br><span class="line">	while (sourceClass !&#x3D; null);</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F;缓存装配类</span><br><span class="line">	this.configurationClasses.put(configClass, configClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要做了3个事情</p>
<ol>
<li>检查装配类是否需要跳过装配，此处用于解析包含<code>@Conditional</code>注解的装配类，例如<code>@ConditionalOnClass @ConditionalOnBean @ConditionalOnProperty</code></li>
<li>检查是否重复加载，如果缓存里存在，则忽略</li>
<li>将装配类转换为SourceClass，并委派给<code>doProcessConfigurationClass()</code> 进行解析，如果返回的结果不为空，则继续循环解析</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">protected final SourceClass doProcessConfigurationClass(ConfigurationClass configClass, SourceClass sourceClass)</span><br><span class="line">		throws IOException &#123;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;检查是否有Component注解，如果拥有的话， 遍历其内部类拥有@Configuration注解的类，递归processConfigurationClass()解析</span><br><span class="line">	if (configClass.getMetadata().isAnnotated(Component.class.getName())) &#123;</span><br><span class="line">		processMemberClasses(configClass, sourceClass);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;检查是否有 @PropertySource 注解，有的话则加载配置文件，追加到环境变量Environment中</span><br><span class="line">	for (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">			sourceClass.getMetadata(), PropertySources.class,</span><br><span class="line">			org.springframework.context.annotation.PropertySource.class)) &#123;</span><br><span class="line">		if (this.environment instanceof ConfigurableEnvironment) &#123;</span><br><span class="line">			processPropertySource(propertySource);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			logger.info(&quot;Ignoring @PropertySource annotation on [&quot; + sourceClass.getMetadata().getClassName() +</span><br><span class="line">					&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 获取@ComponentScan注解配置信息</span><br><span class="line">	Set&lt;AnnotationAttributes&gt; componentScans &#x3D; AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">			sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line">	&#x2F;&#x2F;检查是否拥有@ComponentScan注解信息，并且满足加载条件进入扫描代码块</span><br><span class="line">	if (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line">			!this.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">		for (AnnotationAttributes componentScan : componentScans) &#123;</span><br><span class="line">			&#x2F;**</span><br><span class="line">				委派给 ComponentScanAnnotationParser 把带有自动装配注解的类（例如：@Compoent @Service）扫描出来，并加载到IOC容器中,</span><br><span class="line">				因为 @SpringBootApplication 注解中包含了@ComponentScan注解， 所以会扫描启动类所在包下的所有类</span><br><span class="line">			**&#x2F;</span><br><span class="line">			Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions &#x3D;</span><br><span class="line">					this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">			&#x2F;&#x2F; 遍历扫描出来的元数据BeanDefinitionHolder</span><br><span class="line">			for (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;</span><br><span class="line">				BeanDefinition bdCand &#x3D; holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">				if (bdCand &#x3D;&#x3D; null) &#123;</span><br><span class="line">					bdCand &#x3D; holder.getBeanDefinition();</span><br><span class="line">				&#125;</span><br><span class="line">				&#x2F;&#x2F;检查扫描的类是否包含@Configuration，包含则优先解析扫描出来的ConfigurationClass配置类</span><br><span class="line">				if (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, this.metadataReaderFactory)) &#123;</span><br><span class="line">					parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">		处理 @Import 注解， 主要逻辑是：</span><br><span class="line">		1. 遍历 @Import 的值</span><br><span class="line">		2. 判断值的所属类型</span><br><span class="line">			2.1. 如果是ImportSelector的实现类，则调用 selectImports() 返回 一组配置类递归给 processImports() 方法加载</span><br><span class="line">			2.2. 如果是 DeferredImportSelector 的实现类，则加载到 deferredImportSelectors 内存中 ，延迟加载</span><br><span class="line">			2.3. 如果是 ImportBeanDefinitionRegistrar 的实现类，则会追加到对应的 ConfigurationClass 的importBeanDefinitionRegistrars属性中</span><br><span class="line">				 最后在ConfigurationClassParser.loadBeanDefinitions() 对所有ConfigurationClass进行加载时，</span><br><span class="line">				 会调用 ImportBeanDefinitionRegistrar.registerBeanDefinitions() 通过编码的方式扩展，加载Bean元数据</span><br><span class="line">			2.4. 如果都不是，当成一个配置类， 递归processConfigurationClass() 加载解析</span><br><span class="line">			</span><br><span class="line">		</span><br><span class="line">		我们重点关注DeferredImportSelector，因为@EnableAutoConfiguration注解里导入的类是 AutoConfigurationImportSelector </span><br><span class="line">	**&#x2F;</span><br><span class="line">	processImports(configClass, sourceClass, getImports(sourceClass), true);</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">		处理@ImportResource注解，把spring的bean配置文件缓存到ConfigurationClass.importedResources中，</span><br><span class="line">		最后在ConfigurationClassParser.loadBeanDefinitions()对所有ConfigurationClass进行加载时，会使用 XmlBeanDefinitionReader 进行解析加载</span><br><span class="line">		</span><br><span class="line">	**&#x2F;</span><br><span class="line">	AnnotationAttributes importResource &#x3D;</span><br><span class="line">			AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);</span><br><span class="line">	if (importResource !&#x3D; null) &#123;</span><br><span class="line">		String[] resources &#x3D; importResource.getStringArray(&quot;locations&quot;);</span><br><span class="line">		Class&lt;? extends BeanDefinitionReader&gt; readerClass &#x3D; importResource.getClass(&quot;reader&quot;);</span><br><span class="line">		for (String resource : resources) &#123;</span><br><span class="line">			String resolvedResource &#x3D; this.environment.resolveRequiredPlaceholders(resource);</span><br><span class="line">			configClass.addImportedResource(resolvedResource, readerClass);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 处理带有@Bean注解修饰的方法，并缓存到ConfigurationClass.beanMethods</span><br><span class="line">	Set&lt;MethodMetadata&gt; beanMethods &#x3D; retrieveBeanMethodMetadata(sourceClass);</span><br><span class="line">	for (MethodMetadata methodMetadata : beanMethods) &#123;</span><br><span class="line">		configClass.addBeanMethod(new BeanMethod(methodMetadata, configClass));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	processInterfaces(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 查看是否拥有父类，并且父类不是java开头的包，则返回父类，循环加载父类配置信息</span><br><span class="line">	if (sourceClass.getMetadata().hasSuperClass()) &#123;</span><br><span class="line">		String superclass &#x3D; sourceClass.getMetadata().getSuperClassName();</span><br><span class="line">		if (superclass !&#x3D; null &amp;&amp; !superclass.startsWith(&quot;java&quot;) &amp;&amp;</span><br><span class="line">				!this.knownSuperclasses.containsKey(superclass)) &#123;</span><br><span class="line">			this.knownSuperclasses.put(superclass, configClass);</span><br><span class="line">			&#x2F;&#x2F; Superclass found, return its annotation metadata and recurse</span><br><span class="line">			return sourceClass.getSuperClass();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 没有父类，外层循环结束</span><br><span class="line">	return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>springboot-自动配置</p><p><a href="http://jingruihe.gitee.io/blog/2021/04/20/springboot-1.自动配置/">http://jingruihe.gitee.io/blog/2021/04/20/springboot-1.自动配置/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>JingRui</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-04-20</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-05-12</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/blog/tags/springboot/">springboot</a></div><div class="notification is-danger">You need to set <code>install_url</code> to use ShareThis. Please set it in <code>_config.yml</code>.</div></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/blog/img/zhifubaopay.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/blog/img/weixinpay.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/blog/2021/05/01/spring-1.IOC/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">springIOC源码</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/blog/2021/01/10/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redis/"><span class="level-item">redis分布式锁</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="notification is-danger">You forgot to set the <code>shortname</code> for Disqus. Please set it in <code>_config.yml</code>.</div></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/blog/img/avatar.png" alt="景瑞"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">景瑞</p><p class="is-size-6 is-block">花看半开，酒瘾微醺</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>深圳</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/blog/archives"><p class="title">74</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/blog/categories"><p class="title">1</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/blog/tags"><p class="title">19</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://weibo.com/u/5743551999" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/jingruihe"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/u/5743551999"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/blog/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://0ne0ne.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">肉松饼</span></span><span class="level-right"><span class="level-item tag">0ne0ne.com</span></span></a></li><li><a class="level is-mobile" href="http://evilxyz.xyz/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">神奇的胖子</span></span><span class="level-right"><span class="level-item tag">evilxyz.xyz</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/categories/%E5%90%8E%E5%8F%B0/"><span class="level-start"><span class="level-item">后台</span></span><span class="level-end"><span class="level-item tag">74</span></span></a></li></ul></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2016/01/"><span class="level-start"><span class="level-item">一月 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2015/03/"><span class="level-start"><span class="level-item">三月 2015</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li></ul></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/blog/tags/JPA/"><span class="tag">JPA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/JVM/"><span class="tag">JVM</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/docker/"><span class="tag">docker</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/elasticsearch/"><span class="tag">elasticsearch</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/mongodb/"><span class="tag">mongodb</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/mysql/"><span class="tag">mysql</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/redis/"><span class="tag">redis</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/spring/"><span class="tag">spring</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/springboot/"><span class="tag">springboot</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/zookeeper/"><span class="tag">zookeeper</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><span class="tag">分布式事务</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"><span class="tag">分布式锁</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E5%B7%A5%E5%85%B7/"><span class="tag">工具</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E5%B9%B6%E5%8F%91/"><span class="tag">并发</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"><span class="tag">消息队列</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E6%BA%90%E7%A0%81/"><span class="tag">源码</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E7%AE%97%E6%B3%95/"><span class="tag">算法</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"><span class="tag">解决方案</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="tag">设计模式</span><span class="tag">5</span></a></div></div></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-13T03:35:25.000Z">2021-05-13</time></p><p class="title"><a href="/blog/2021/05/13/mysql-A5.%E6%AD%BB%E9%94%81/">mysql-死锁</a></p><p class="categories"><a href="/blog/categories/%E5%90%8E%E5%8F%B0/">后台</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-09T03:35:25.000Z">2021-05-09</time></p><p class="title"><a href="/blog/2021/05/09/spring-6.aware/">springAware源码</a></p><p class="categories"><a href="/blog/categories/%E5%90%8E%E5%8F%B0/">后台</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-07T03:35:25.000Z">2021-05-07</time></p><p class="title"><a href="/blog/2021/05/07/spring-5.event/">spring-Event源码</a></p><p class="categories"><a href="/blog/categories/%E5%90%8E%E5%8F%B0/">后台</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-04T03:35:25.000Z">2021-05-04</time></p><p class="title"><a href="/blog/2021/05/04/spring-3.aop/">springAOP源码</a></p><p class="categories"><a href="/blog/categories/%E5%90%8E%E5%8F%B0/">后台</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-01T03:35:25.000Z">2021-05-01</time></p><p class="title"><a href="/blog/2021/05/01/spring-1.IOC/">springIOC源码</a></p><p class="categories"><a href="/blog/categories/%E5%90%8E%E5%8F%B0/">后台</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/blog/"><img src="/blog/img/logo.svg" alt="景瑞的博客" height="28"></a><p class="is-size-7"><span>&copy; 2021 JingRui</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on Gitee" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/blog/js/column.js"></script><script src="/blog/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/blog/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/blog/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/blog/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/blog/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>